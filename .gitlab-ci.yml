# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/ee/user/application_security/secret_detection/pipeline/#customization
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Container Scanning customization: https://docs.gitlab.com/ee/user/application_security/container_scanning/#customizing-the-container-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence
image: node:20
variables:
  GIT_DEPTH: 0
stages:
  - build
  - triage
  - test
include:
  - template: Security/SAST.gitlab-ci.yml
    rules:
      - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  - component: gitlab.com/components/gitlab-triage/gitlab-triage@main
    inputs:
      api_token: $DEVELOPER_WRITE_API
      stage: triage
    rules:
      - if: $CI_PIPELINE_SOURCE == "schedule"

main:
  stage: build
  interruptible: true
  only:
    - merge_requests
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - .npm/
  script:
    - npm ci --cache .npm --prefer-offline
    - NX_HEAD=$CI_COMMIT_SHA
    - NX_BASE=${CI_MERGE_REQUEST_DIFF_BASE_SHA:-$CI_COMMIT_BEFORE_SHA}
    - npx nx-cloud record -- nx format:check --base=$NX_BASE --head=$NX_HEAD
    - npx nx affected --base=$NX_BASE --head=$NX_HEAD -t lint build
    - npx nx daemon --stop
tests:
  stage: test
  interruptible: true
  only:
    - merge_requests
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - .npm/
  script:
    - npm ci --cache .npm --prefer-offline
    - NX_HEAD=$CI_COMMIT_SHA
    - NX_BASE=${CI_MERGE_REQUEST_DIFF_BASE_SHA:-$CI_COMMIT_BEFORE_SHA}
    - npx nx affected --base=$NX_BASE --head=$NX_HEAD -t test
    - npx nx affected --base=$NX_BASE --head=$NX_HEAD -t e2e-ci --parallel 1
  artifacts:
    reports:
      junit: test-results/**/*.xml
    paths:
      - test-results/**/*.xml
    when: always
